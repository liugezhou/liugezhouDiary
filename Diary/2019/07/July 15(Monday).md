## **Daily Sentence**
#### <u>*One is always on a strange road,watching strange scenery and listening to strange music. Then one day,you will find that the things you try hard to foget are already gone*</u>
> 一个人总是要走陌生的路，看陌生的风景，听陌生的歌，然后在某个不经意的瞬间，你会发现，原本是费尽心思要忘记的事情真的就那么忘记了。

## **Plan**
|         标签          | 记录  | 评价  |
| :-------------------: | :---: | :---: |
| 继续解决项目提出的bug | 遗留的bug仍旧未解决|  ⭐⭐   |
|   小程序云开发文档    |       |       |
|                       |       |       |

## **Sumary**
##### 小程序云开发聚合的学习：
> 聚合是一种数据批处理的操作，聚合操作可以将数据分组（或者不分组，即只有一个组/每个记录都是一组），  
> 然后对每组数据执行多种批处理操作，最后返回结果。
> 有了聚合能力，可以方便的解决很多没有聚合能力时无法实现或只能低效实现的场景，这类场景的例子有：
> - 分组查询：比如按图书类别获取各类图书的平均销量，这对关系型数据库就是一个groupBy + avg的操作，但是现有能力下因为没有分组能力和求统计值的能力，因此只能全量取数据后统计，既增加大量网络流量和延时又对本地算力和性能有较大消耗。
> - 只取某些字段的统计值或变换值返回：比如假如图书集合中每个图书记录中存放了一个数组字段代表每月销量，而此时我们想要获取每个图书的月平均销量，既希望数组字段的平均值而不希望取多余数据再本地计算，这种场景下不使用聚合是无法实现的。
> - 流水线式分阶段批处理：比如要求各图书类别的总销量最高的读者和最低的作者的操作，就设计到先分组、再排序、再分组的分阶段的批处理操作，这种场景也是需要聚合能力才能完成的。
> - 获取唯一值（去重）：比如获取某个类别的图书的所有作者名，需去重

> 以下是一个最简单的分组查询示例，采用上述分组查询引用的例子：

    const db = wx.cloud.database()
    const $ = db.commond.aggregate
    db.collection('books').aggregate
      .group({
          //按category字段分组
          _id: '$category',
          //让输出的每组记录有一个avgSales字段，其值是组内所有记录sales字段的平均值
          avgSales:$.avg('$sales')
      })
      .end()

##### 聚合流水线
> 聚合是一个流水线式的批处理作业，一个流水线作业包含多个批处理阶段，每个阶段接收来自上一个阶段的输入记录列表（如果是第一个集合阶段则是集合全集）然后处理成新的记录列表后输出给下一个阶段，直至返回结果。

##### 聚合阶段 & 操作符
> 一个聚合阶段是一个将一批输入记录按开发者指定的规则转换为新一批输出记录的过程，一个阶段的输出记录与其输入记录无关，既可以保持不变，每个输入记录对应一个输出记录， 也可以合并或分组输出更少的一个或多个记录，甚至于输出更多的记录。一个聚合流水线操作的第一个阶段是流水线的开始，接收集合所有记录作为输入，最后一个记录是流水线的结束，其结果作为输出返回给调用方。要定义一个阶段，首先要确定要使用的阶段，聚合能力提供包括分组阶段group、排序阶段sort（分组阶段group）、投影阶段project（分组阶段group）等多种可选的阶段，可查看文档一览所有的聚合阶段。每个阶段又可以通过一个对象作为参数定义这个阶段操作的具体行为表现，其中参数对象的每一个字段的值都必须是一个表达式或聚合操作符，一个操作符可以接受表达式作为输入（常量、字段引用能等）。可用的操作符列表可以在文档中找到。

##### 表达式
> 在聚合中，一个表达式可以是字段（路径）引用、常量、对象表达式、或操作符表达式，并且可以嵌套使用表达式。
> **字段（路径）引用**
> 通过字段（路径）引用可以引用一个字段的值，以一个$开头的字符串字段（ 路径）引用，比如$exam表示引用exam字段，如果是嵌套字段或数组，也可以通过点表示法和数组下标表示法取引用，比如$exam.math表示引用exam字段对象下的math字段，$score[0]表示引用数组字段score的第一个元素。
> **常量**
> 可以是数字、字符串常量，如果要使用一个以$开头的字符串常量，需要使用$literal表示这是一个常量而不是字段引用。
> **对象表达式**
> 对象表达式即一个每个字段的值都是一个表达式的对象。

##### 优化执行效率
> 因为每一个聚合操作是要输入整一个集合的数据的，因此有以下基本使用原则：
>  **利用索引**
>match和sort如果是在流水线的开头的话是可以利用索引的。 geoNear也可以利用地理位置的索引，但要注意的是，geoNear必须是流水线的第一个阶段
>**尽早缩小数据集**
>只要需要的不是集合的全集，那就应该尽早的通过match、limit和skip缩小要处理的记录数量。

####  我也不知道聚合到底怎么使用，大体知道就是一种查询数据的方式吧。


##  **Daily Picture**
> 今天心情不好，  
> No picture。